Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var r in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+r+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[r]:("00"+t[r]).substr((""+t[r]).length)));return e};var Main={data:()=>({downloading:!1,pretty_json:!1,drawer:!1,options:"",docs:"",current_template:"",crawler_rule:{name:"",description:"",input_callback:"",regex:"^https://httpbin.org/html$",parse_rules:[{name:"title",chain_rules:[["css","title,h1","$text"],["py","index","0"]],child_rules:"[]",iter_parse_child:!1}],request_args:JSON.stringify({method:"get",url:"https://httpbin.org/html"},null,2)},input_object:"",request_status:"",parse_result:"",current_doc:"",doc_drawer:!1,new_rule_visible:!1,new_rule_json:"",parse_rule_idx_to_send:null,send_child_rule_visible:!1,template_visible:!1,request_template_values:{},show_parse_result_as_json:!0,custom_args:"",demo_choices:[],cb_names:"",show_toc:!0}),methods:{jump_rule(e){switch(e){case 0:document.getElementById("app").scrollIntoView();break;case 1:this.download();break;case 2:this.parse();break;case 3:this.load_rule_popup();break;default:document.querySelectorAll(".rule")[e-4].scrollIntoView()}},querySearch(e,t){var r=this.options;t(e?r.filter(this.createFilter(e)):r)},createFilter:e=>t=>0===t.value.toLowerCase().indexOf(e.toLowerCase()),openAlert(e,t){this.$alert(e,t,{confirmButtonText:"Ok",distinguishCancelAndClose:!0,closeOnPressEscape:!0,closeOnClickModal:!0})},download(){var e=this.current_crawler_rule_json;this.downloading=!0,this.request_status="(Downloading)",this.input_object="",this.$http.post("request",e).then(e=>{let t=e.body.text;if(this.input_object=t.replace(/^\s+/,""),!this.crawler_rule.name){let e="Rule ("+(new Date).Format("yyyy-MM-dd HH:mm:ss")+")";try{var r=(new DOMParser).parseFromString(t,"text/html");let s=(r.getElementsByTagName("title")[0]||r.getElementsByTagName("h1")[0]||r.getElementsByTagName("h2")[0]||"").innerText,l=(s=s.replace(/-.*/g,""))||this.crawler_rule.request_args.url||e;this.crawler_rule.name=l}catch(t){this.crawler_rule.name=e}}this.request_status=e.body.status;let s=e.body.ok?"green":"red";if(document.querySelector("#request_status>label").style.color=s,this.downloading=!1,e.body.msg){const t=this.$createElement;this.$notify({title:"Warning",message:t("b",e.body.msg),type:"warning",position:"top-left"})}},e=>{this.status="testTask failed, Bad request ("+e.status+") :"+e.statusText,this.status_icon_flag="error",this.downloading=!1,this.openAlert(this.status)})},parse(){var e={rule:this.current_crawler_rule_json,input_object:this.input_object};if(!this.crawler_rule.parse_rules||!this.input_object)return this.download(),void this.openAlert("Can not parse it before downloading, now wait for downloading finished.");this.$http.post("parse",JSON.stringify(e)).then(e=>{this.parse_result=e.body,this.drawer=!0},e=>{this.openAlert(e.body,"Request Error")})},add_new_rule_chain(e){this.crawler_rule.parse_rules[e].chain_rules.push(["","",""])},add_new_rule(){this.crawler_rule.parse_rules.push({name:"",chain_rules:[["","",""]],child_rules:"",iter_parse_child:!1})},prepose_rule(){if(this.send_child_rule_visible=!1,null!=this.parse_rule_idx_to_send){let e=this.crawler_rule.parse_rules.splice(this.parse_rule_idx_to_send,1)[0];this.crawler_rule.parse_rules.unshift(e)}this.parse_rule_idx_to_send=null},tail_rule(){if(this.send_child_rule_visible=!1,null!=this.parse_rule_idx_to_send){let e=this.crawler_rule.parse_rules.splice(this.parse_rule_idx_to_send,1)[0];this.crawler_rule.parse_rules.push(e)}this.parse_rule_idx_to_send=null},send_child(e,t){this.send_child_rule_visible=!1;let r=JSON.parse(e.child_rules||"[]"),s=this.crawler_rule.parse_rules[this.parse_rule_idx_to_send];s.child_rules=JSON.parse(s.child_rules||"[]"),r.push(s),this.crawler_rule.parse_rules[t].child_rules=JSON.stringify(r),this.crawler_rule.parse_rules.splice(this.parse_rule_idx_to_send,1)[0],this.parse_rule_idx_to_send=null,setTimeout(()=>{for(const e of document.getElementsByTagName(".child-rules-input>textarea"))e.style.height="auto",e.style.height=e.scrollHeight+"px";this.iframe_loaded=!0},0)},open_send_child_dialog(e){this.parse_rule_idx_to_send=e,this.send_child_rule_visible=!0},del_rule(e){this.crawler_rule.parse_rules.splice(e,1)},del_rule_chain(e,t){this.crawler_rule.parse_rules[e].chain_rules.splice(t,1)},get_doc(e){this.current_doc=this.docs[e]||"Not found parser: "+e,this.doc_drawer=!0},load_rule(){if(this.new_rule_json)try{var e=JSON.parse(this.new_rule_json),t=["name","description","regex","parse_rules","request_args","input_callback"],r={};for(key in e)t.indexOf(key)<0&&(r[key]=e[key]);Object.keys(r)[0]?this.custom_args=JSON.stringify(r):this.custom_args="",e.request_args&&e.request_args.url&&(e.request_args=JSON.stringify(e.request_args,null,2)),e.request_template&&(e.request_template=JSON.stringify(e.request_template,null,2)),e.parse_rules.forEach(e=>{e.child_rules&&(e.child_rules=JSON.stringify(e.child_rules))}),this.crawler_rule=e,this.new_rule_visible=!1}catch(e){alert(e)}else this.new_rule_visible=!1},load_rule_popup(){this.new_rule_visible=!0,setTimeout(()=>{this.$refs.load_json_input.focus()},0),this.new_rule_json||(this.new_rule_json=this.current_crawler_rule_json)},show_request_template(){this.template_visible=!0,this.current_template=this.crawler_rule.request_template||this.crawler_rule.request_args,this.request_template_values={}},update_template(){try{JSON.parse(this.current_template),this.$set(this.crawler_rule,"request_template",this.current_template)}catch(e){this.openAlert(e,"Error")}},add_to_request_args(){try{new Set(this.current_template.match(/\$\{.*?\}/g)).forEach(e=>{if(!this.request_template_values[e])throw e+" should not be null"});let e=this.current_template;Object.keys(this.request_template_values).forEach(t=>{let r=0;for(;r<1e3;){r+=1;let s=e.replace(t,this.request_template_values[t]);if(s==e)break;e=s}}),this.$set(this.crawler_rule,"request_args",JSON.stringify(JSON.parse(e),null,2)),this.template_visible=!1}catch(e){this.openAlert(e,"Error"),this.template_visible=!0}},demo_handle_click(e){this.new_rule_json=this.demo_choices[1*e][1],this.input_object="",this.request_status="",this.load_rule()},input_encoding(){this.$prompt("Input the encoding of response","",{confirmButtonText:"OK",cancelButtonText:"Cancel"}).then(({value:e})=>{let t=JSON.parse(this.crawler_rule.request_args);t.encoding=e,this.crawler_rule.request_args=JSON.stringify(t,null,2)}).catch(()=>{})},input_curl(){this.$prompt("Input cURL string (or URL)","",{confirmButtonText:"OK",cancelButtonText:"Cancel",inputPattern:/^(curl |http).*/,inputErrorMessage:"cURL string should start with curl, or url should start with http"}).then(({value:e})=>{if(fill_regex=(e=>{e&&!this.crawler_rule.regex&&(this.crawler_rule.regex="^"+e.replace(/([\.\?\+\*\^\$])/g,"\\$1").replace(/^https?:\/\//,"https?://")+"$")}),/^https?:\/\/.*/.test(e))try{let t;try{t=JSON.parse(this.crawler_rule.request_args)}catch(r){t={method:"get",url:e,headers:{"User-Agent":"Chrome"}}}return t.url=e,this.crawler_rule.request_args=JSON.stringify(t,null,2),void fill_regex(e)}catch(e){}else this.$http.post("curl_parse",e).then(e=>{let t=e.body;if(t.ok){this.crawler_rule.request_args=JSON.stringify(t.result,null,2);let e=t.result.url;fill_regex(e)}else this.$message({type:"error",message:"cURL parse failed: "+t.result})},()=>{this.$message({type:"error",message:"cURL parse failed"})})}).catch(()=>{})},handle_cache(e){switch(e){case"save":localStorage.setItem("uniparser_cache",this.current_crawler_rule_json),this.openAlert("Cache saved");break;case"load":var t=localStorage.getItem("uniparser_cache");t&&(this.new_rule_json=t,this.load_rule(),this.openAlert("Cache loaded"));break;case"clear":localStorage.clear("uniparser_cache"),this.openAlert("Cache cleared")}}},watch:{},computed:{current_request_url:function(){try{return JSON.parse(this.crawler_rule.request_args).url||""}catch(e){return""}},current_crawler_rule_json:function(){try{var e=[];this.crawler_rule.parse_rules.forEach(t=>{if(t.name){try{var r=JSON.parse(t.child_rules||"[]")}catch(e){r=t.child_rules}var s=[];t.chain_rules.forEach(e=>{(e[0]||e[1]||e[2])&&s.push([e[0],e[1],e[2]])}),e.push({name:t.name,chain_rules:s,child_rules:r,iter_parse_child:t.iter_parse_child})}});var t={name:this.crawler_rule.name,description:this.crawler_rule.description,request_args:JSON.parse(this.crawler_rule.request_args),parse_rules:e,regex:this.crawler_rule.regex,input_callback:this.crawler_rule.input_callback},r=this.custom_args?JSON.parse(this.custom_args):{};for(const e in r)r.hasOwnProperty(e)&&(t[e]=r[e]);return this.crawler_rule.request_template&&(t.request_template=JSON.parse(this.crawler_rule.request_template)),this.crawler_rule.request_args=JSON.stringify(t.request_args,null,2),this.pretty_json?JSON.stringify(t,null,2):JSON.stringify(t)}catch(e){return e}}}};function init_app(e){let t=document.getElementById("init_vars"),r=JSON.parse(window.atob(t.innerHTML));Object.keys(r).forEach(t=>{e[t]=r[t]}),t.parentNode.removeChild(t),new ClipboardJS(".cp-button").on("success",function(){e.$message({message:"Copy success",type:"success"})}),e.demo_handle_click(0),e.handle_cache("load")}var vue_app=Vue.extend(Main),app=new vue_app({delimiters:["${","}"]}).$mount("#app");init_app(app);
